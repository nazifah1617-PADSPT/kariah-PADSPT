<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Data Masjid Seberang Perai Tengah</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .header-bg { background: linear-gradient(90deg, #1e3a8a 0%, #172554 100%); }
        .gold-line { height: 4px; background: #fbbf24; }
        
        .file-upload-wrapper {
            position: relative; width: 100%; height: 50px;
            border: 2px dashed #cbd5e1; border-radius: 0.5rem;
            display: flex; align-items: center; justify-content: center;
            background-color: #f8fafc; transition: all 0.3s; cursor: pointer;
        }
        .file-upload-wrapper:hover { border-color: #1e40af; background-color: #eff6ff; }
        
        .loader {
            border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3498db;
            width: 20px; height: 20px; animation: spin 1s linear infinite; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Table Styling for Admin */
        .admin-table th { background-color: #1e3a8a; color: white; text-align: left; padding: 12px; }
        .admin-table td { padding: 12px; border-bottom: 1px solid #e2e8f0; }
        .admin-table tr:nth-child(even) { background-color: #f8fafc; }
        .admin-table tr:hover { background-color: #eff6ff; }

        /* PRINT STYLING - Kunci untuk PDF */
        @media print {
            body * { visibility: hidden; }
            #printModal, #printModal *, #summaryModal, #summaryModal * { visibility: visible; }
            
            /* Logic untuk papar modal yang betul bila print */
            #printModal { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white; z-index: 9999; }
            #summaryModal { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white; z-index: 9999; }
            
            .no-print { display: none !important; }
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen text-gray-800">

    <!-- Header -->
    <header class="header-bg text-white shadow-lg no-print">
        <div class="gold-line"></div>
        <div class="container mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <img src="https://i.postimg.cc/HsVZqzF5/JATAPenang.png" alt="Logo Rasmi" class="h-16 w-auto bg-white rounded-lg p-1 shadow-md object-contain">
                <div>
                    <h1 class="text-sm md:text-lg font-bold uppercase tracking-wide">Pejabat Agama Daerah</h1>
                    <h2 class="text-xs md:text-sm font-light text-blue-200">Seberang Perai Tengah</h2>
                </div>
            </div>
            <div class="hidden md:block">
                <span class="text-xs bg-blue-800 px-3 py-1 rounded border border-blue-600">Portal Pengurusan Data</span>
            </div>
        </div>
    </header>

    <!-- Main Content (Borang Awam) -->
    <main id="publicSection" class="flex-grow container mx-auto px-4 py-8 md:py-12 no-print">
        <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-2xl overflow-hidden border border-gray-200">
            <div class="bg-gray-50 px-6 py-5 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    <i class="fas fa-mosque text-blue-900 mr-3"></i> Borang Data Maklumat Masjid
                </h3>
                <span class="text-xs font-semibold text-gray-500 bg-gray-200 px-2 py-1 rounded">Sulit & Rasmi</span>
            </div>

            <div class="p-6 md:p-8">
                <p class="mb-6 text-sm text-gray-600 bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                    <i class="fas fa-info-circle mr-2"></i>
                    Sila lengkapkan maklumat di bawah dengan teliti. Pastikan salinan akaun bank dimuat naik dalam format gambar atau PDF untuk tujuan bantuan kepada masjid terpilih.
                </p>

                <form id="masjidForm" class="space-y-6">
                    <!-- Nama Masjid -->
                    <div>
                        <label for="namaMasjid" class="block text-sm font-semibold text-gray-700 mb-2">Nama Masjid <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <!-- Ditambah onchange="toggleManualInput(this)" -->
                            <select id="namaMasjid" name="namaMasjid" required onchange="toggleManualInput(this)" class="block w-full pl-3 pr-10 py-3 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md border shadow-sm appearance-none bg-white text-gray-900">
                                <option value="" disabled selected>-- Sila Pilih Masjid --</option>
                                <option value="Masjid Pengkalan Tambang">Masjid Pengkalan Tambang</option>
                                <option value="Masjid Bukit Indera Muda">Masjid Bukit Indera Muda</option>
                                <option value="Masjid Permatang Nibong">Masjid Permatang Nibong</option>
                                <option value="Masjid Haji Saad">Masjid Haji Saad</option>
                                <option value="Masjid Permatang Batu">Masjid Permatang Batu</option>
                                <option value="Masjid Kampung Pelet">Masjid Kampung Pelet</option>
                                <option value="Masjid Kuala Mengkuang">Masjid Kuala Mengkuang</option>
                                <option value="Masjid Mengkuang Semarak">Masjid Mengkuang Semarak</option>
                                <option value="Masjid Sama Gagah">Masjid Sama Gagah</option>
                                <option value="Masjid Kubang Ulu">Masjid Kubang Ulu</option>
                                <!-- Pilihan Baru Lain-lain -->
                                <option value="Lain-lain" class="font-bold text-blue-800 bg-blue-50">Lain-lain (Nyatakan Sendiri)</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700"><i class="fas fa-chevron-down text-xs"></i></div>
                        </div>
                        
                        <!-- Input Manual (Hidden by default) -->
                        <div id="manualInputContainer" class="hidden mt-3 animate-fade-in-down">
                            <label for="namaMasjidManual" class="block text-sm font-semibold text-gray-700 mb-2">Nyatakan Nama Masjid <span class="text-red-500">*</span></label>
                            <input type="text" id="namaMasjidManual" name="namaMasjidManual" class="focus:ring-blue-500 focus:border-blue-500 block w-full pl-3 sm:text-sm border-gray-300 rounded-md py-3 border bg-blue-50" placeholder="Sila taip nama penuh masjid di sini...">
                        </div>
                    </div>

                    <!-- Nama Pengerusi -->
                    <div>
                        <label for="namaPengerusi" class="block text-sm font-semibold text-gray-700 mb-2">Nama Pengerusi <span class="text-red-500">*</span></label>
                        <input type="text" name="namaPengerusi" id="namaPengerusi" required class="focus:ring-blue-500 focus:border-blue-500 block w-full pl-3 sm:text-sm border-gray-300 rounded-md py-3 border" placeholder="Cth: Hj. Ahmad bin Albab">
                    </div>

                    <!-- No Telefon -->
                    <div>
                        <label for="noTelefon" class="block text-sm font-semibold text-gray-700 mb-2">Nombor Telefon <span class="text-red-500">*</span></label>
                        <input type="tel" name="noTelefon" id="noTelefon" required class="focus:ring-blue-500 focus:border-blue-500 block w-full pl-3 sm:text-sm border-gray-300 rounded-md py-3 border" placeholder="Cth: 012-3456789">
                    </div>

                    <!-- Akaun Masjid Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="noAkaun" class="block text-sm font-semibold text-gray-700 mb-2">Nombor Akaun Masjid <span class="text-red-500">*</span></label>
                            <input type="number" name="noAkaun" id="noAkaun" required class="focus:ring-blue-500 focus:border-blue-500 block w-full pl-3 sm:text-sm border-gray-300 rounded-md py-3 border" placeholder="Cth: 1234567890">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Salinan Penyata Akaun Masjid <span class="text-red-500">*</span></label>
                            <div class="file-upload-wrapper" onclick="document.getElementById('fileAkaun').click()">
                                <span id="fileName" class="text-sm text-gray-500 select-none"><i class="fas fa-cloud-upload-alt mr-2 text-blue-600"></i> Klik untuk muat naik</span>
                                <input type="file" id="fileAkaun" name="fileAkaun" class="hidden" accept="image/*,.pdf" onchange="updateFileName(this, 'fileName')">
                            </div>
                        </div>
                    </div>

                    <!-- Maklumat Surau -->
                    <div class="pt-8 mt-4 border-t-2 border-dashed border-gray-200">
                        <h4 class="text-lg font-bold text-gray-800 mb-3 flex items-center"><i class="fas fa-moon text-blue-900 mr-2"></i> Maklumat Surau (Pencalonan)</h4>
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-r">
                            <div class="flex"><div class="flex-shrink-0"><i class="fas fa-exclamation-circle text-yellow-600"></i></div>
                                <div class="ml-3"><p class="text-sm text-yellow-700 font-medium">Sila calonkan nama surau dan nombor akaun surau berkenaan di bawah kariah tuan untuk tujuan bantuan (Wajib diisi).</p></div>
                            </div>
                        </div>
                        <div class="space-y-6">
                            <div>
                                <label for="namaSurau" class="block text-sm font-semibold text-gray-700 mb-2">Nama Surau <span class="text-red-500">*</span></label>
                                <input type="text" name="namaSurau" id="namaSurau" required class="focus:ring-blue-500 focus:border-blue-500 block w-full pl-3 sm:text-sm border-gray-300 rounded-md py-3 border" placeholder="Cth: Surau Al-Hidayah">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="noAkaunSurau" class="block text-sm font-semibold text-gray-700 mb-2">Nombor Akaun Surau <span class="text-red-500">*</span></label>
                                    <input type="number" name="noAkaunSurau" id="noAkaunSurau" required class="focus:ring-blue-500 focus:border-blue-500 block w-full pl-3 sm:text-sm border-gray-300 rounded-md py-3 border" placeholder="Cth: 1234567890">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Salinan Akaun Surau <span class="text-red-500">*</span></label>
                                    <div class="file-upload-wrapper" onclick="document.getElementById('fileAkaunSurau').click()">
                                        <span id="fileNameSurau" class="text-sm text-gray-500 select-none"><i class="fas fa-cloud-upload-alt mr-2 text-blue-600"></i> Klik untuk muat naik</span>
                                        <input type="file" id="fileAkaunSurau" name="fileAkaunSurau" class="hidden" accept="image/*,.pdf" onchange="updateFileName(this, 'fileNameSurau')">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="pt-4">
                        <button type="submit" id="btnHantar" class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-900 hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-900 transition-colors duration-200">
                            <span id="btnText">HANTAR DATA</span><div id="loadingSpinner" class="loader ml-3"></div>
                        </button>
                    </div>
                </form>
            </div>
            
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-200 text-center flex justify-between items-center">
                <p class="text-xs text-gray-500">&copy; 2025 Pejabat Agama Daerah Seberang Perai Tengah.</p>
                <button onclick="toggleAdminLogin()" class="text-xs text-gray-400 hover:text-blue-600 font-semibold"><i class="fas fa-lock mr-1"></i> Admin</button>
            </div>
        </div>
    </main>

    <!-- ADMIN SECTION (Hidden by default) -->
    <section id="adminSection" class="hidden flex-grow container mx-auto px-4 py-8 no-print">
        <div class="bg-white rounded-xl shadow-2xl border border-gray-200 overflow-hidden">
            <div class="bg-blue-900 text-white px-6 py-4 flex justify-between items-center">
                <h3 class="text-xl font-bold"><i class="fas fa-database mr-2"></i> Admin Dashboard</h3>
                <div class="flex items-center space-x-3">
                    <span class="text-xs bg-blue-800 px-2 py-1 rounded">Log Masuk Sebagai: Admin</span>
                    <button onclick="logoutAdmin()" class="bg-red-500 hover:bg-red-600 text-xs px-3 py-1 rounded transition font-bold">Log Keluar</button>
                </div>
            </div>
            
            <div class="p-4 bg-gray-50 border-b flex justify-between items-center flex-wrap gap-2">
                <div>
                    <h4 class="font-bold text-gray-700">Senarai Permohonan</h4>
                    <p class="text-xs text-gray-500">Data diambil terus daripada Google Sheet (Live CSV)</p>
                </div>
                <div class="flex items-center space-x-2">
                    <span id="statusAdmin" class="text-xs text-gray-600 italic">Menunggu data...</span>
                    <!-- Butang Refresh -->
                    <button onclick="fetchAdminData()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm shadow flex items-center">
                        <i class="fas fa-sync-alt mr-2"></i> Refresh
                    </button>
                    <!-- Butang Laporan Penuh Baru -->
                    <button onclick="openSummaryReport()" class="bg-purple-700 hover:bg-purple-800 text-white px-4 py-2 rounded text-sm shadow flex items-center">
                        <i class="fas fa-table mr-2"></i> Laporan Penuh
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto p-4">
                <table class="min-w-full bg-white admin-table border text-sm w-full">
                    <thead>
                        <tr>
                            <th class="whitespace-nowrap rounded-tl-lg">Tarikh</th>
                            <th>Nama Masjid</th>
                            <th>Pengerusi & Telefon</th>
                            <th>Akaun Masjid</th>
                            <th>Maklumat Surau</th>
                            <th class="text-center">Tindakan</th>
                        </tr>
                    </thead>
                    <tbody id="adminTableBody" class="text-gray-700">
                        <!-- Data akan dimasukkan di sini -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- EDIT MODAL -->
    <div id="editModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-50 flex items-center justify-center backdrop-blur-sm no-print">
        <div class="bg-white rounded-lg p-6 w-full max-w-lg shadow-2xl border border-gray-200 overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-lg font-bold text-gray-800"><i class="fas fa-edit text-blue-600 mr-2"></i> Kemaskini Data</h3>
                <button onclick="closeEditModal()" class="text-gray-500 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            
            <form id="editForm" class="space-y-4">
                <input type="hidden" id="editRowIndex">
                
                <div>
                    <label class="block text-xs font-bold text-gray-700">Nama Masjid</label>
                    <input type="text" id="editNamaMasjid" class="w-full border p-2 rounded text-sm" readonly> <!-- Readonly untuk elak duplicate -->
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-700">Nama Pengerusi</label>
                        <input type="text" id="editNamaPengerusi" class="w-full border p-2 rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700">No Telefon</label>
                        <input type="text" id="editNoTelefon" class="w-full border p-2 rounded text-sm">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-700">No Akaun Masjid</label>
                    <input type="text" id="editNoAkaun" class="w-full border p-2 rounded text-sm">
                </div>
                <div class="border-t pt-2 mt-2">
                    <label class="block text-xs font-bold text-gray-700">Nama Surau</label>
                    <input type="text" id="editNamaSurau" class="w-full border p-2 rounded text-sm">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-700">No Akaun Surau</label>
                    <input type="text" id="editNoAkaunSurau" class="w-full border p-2 rounded text-sm">
                </div>

                <div class="pt-4 flex justify-end space-x-2">
                    <button type="button" onclick="closeEditModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded text-sm font-semibold">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-blue-900 text-white rounded text-sm font-bold hover:bg-blue-800 flex items-center">
                        <i class="fas fa-save mr-2"></i> Simpan Perubahan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- INDIVIDUAL REPORT VIEW / PDF MODAL -->
    <div id="printModal" class="hidden bg-white min-h-screen p-8">
        <div class="max-w-[210mm] mx-auto mb-6 flex justify-between items-center no-print bg-gray-100 p-4 rounded border">
            <span class="font-bold text-gray-700">Paparan Cetakan / PDF</span>
            <div>
                <button onclick="closePrintView()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 mr-2 text-sm">Tutup</button>
                <button onclick="window.print()" class="px-4 py-2 bg-blue-900 text-white rounded hover:bg-blue-800 shadow text-sm font-bold"><i class="fas fa-print mr-1"></i> Cetak / Simpan PDF</button>
            </div>
        </div>
        <div class="max-w-[210mm] mx-auto bg-white border border-gray-200 shadow-lg p-10 print:border-0 print:shadow-none print:p-0" style="min-height: 297mm;">
            <div class="flex items-center border-b-4 border-blue-900 pb-4 mb-8">
                <img src="https://i.postimg.cc/HsVZqzF5/JATAPenang.png" alt="Logo" class="h-24 w-auto object-contain mr-6">
                <div>
                    <h1 class="text-2xl font-bold text-blue-900 uppercase">Pejabat Agama Daerah</h1>
                    <h2 class="text-xl font-semibold text-gray-700">Seberang Perai Tengah</h2>
                    <p class="text-sm text-gray-500 mt-1">Laporan Data & Permohonan Bantuan Masjid/Surau</p>
                </div>
            </div>
            <div id="printContent"></div>
            <div class="mt-16 pt-8 border-t border-gray-300 grid grid-cols-2 gap-10">
                <div>
                    <p class="text-sm text-gray-500 mb-16">Disediakan Oleh:</p>
                    <div class="border-t border-black w-2/3"></div>
                    <p class="text-sm font-bold mt-1">Pentadbir Sistem</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 mb-16">Disahkan Oleh:</p>
                    <div class="border-t border-black w-2/3"></div>
                    <p class="text-sm font-bold mt-1">Pegawai Tadbir Agama</p>
                </div>
            </div>
            <div class="mt-8 text-center text-xs text-gray-400">Laporan ini dijana secara komputer.</div>
        </div>
    </div>

    <!-- SUMMARY REPORT MODAL (BARU) -->
    <div id="summaryModal" class="hidden bg-white min-h-screen p-8">
        <!-- Header Controls (No Print) -->
        <div class="max-w-[297mm] mx-auto mb-6 flex justify-between items-center no-print bg-gray-100 p-4 rounded border">
            <span class="font-bold text-gray-700">Laporan Keseluruhan Data</span>
            <div>
                <button onclick="closeSummaryReport()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 mr-2 text-sm">Tutup</button>
                <button onclick="window.print()" class="px-4 py-2 bg-blue-900 text-white rounded hover:bg-blue-800 shadow text-sm font-bold"><i class="fas fa-print mr-1"></i> Cetak Laporan</button>
            </div>
        </div>

        <!-- Landscape A4 Container -->
        <div class="max-w-[297mm] mx-auto bg-white border border-gray-200 shadow-lg p-10 print:border-0 print:shadow-none print:p-0 print:max-w-full" style="min-height: 210mm;">
            <!-- Header Laporan -->
            <div class="text-center border-b-4 border-blue-900 pb-4 mb-6">
                <h1 class="text-2xl font-bold text-blue-900 uppercase">Pejabat Agama Daerah Seberang Perai Tengah</h1>
                <h2 class="text-xl font-semibold text-gray-700">Laporan Ringkasan Data Masjid & Surau</h2>
                <p class="text-sm text-gray-500 mt-2">Tarikh Laporan: <span id="summaryDate"></span></p>
            </div>

            <!-- Table Content -->
            <div class="overflow-x-auto">
                <table class="w-full text-sm border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-gray-200 text-gray-700">
                            <th class="border border-gray-300 px-2 py-2 w-10">Bil</th>
                            <th class="border border-gray-300 px-2 py-2">Nama Masjid</th>
                            <th class="border border-gray-300 px-2 py-2">Nama Pengerusi</th>
                            <th class="border border-gray-300 px-2 py-2">No. Telefon</th>
                            <th class="border border-gray-300 px-2 py-2">No. Akaun Masjid</th>
                            <th class="border border-gray-300 px-2 py-2">Nama Surau (Pencalonan)</th>
                            <th class="border border-gray-300 px-2 py-2">No. Akaun Surau</th>
                        </tr>
                    </thead>
                    <tbody id="summaryTableBody">
                        <!-- Rows -->
                    </tbody>
                </table>
            </div>

            <div class="mt-8 text-right">
                <p class="font-bold text-gray-700">Jumlah Data: <span id="totalDataCount">0</span></p>
            </div>
            
            <div class="mt-8 text-center text-xs text-gray-400">
                Laporan ini dijana secara komputer melalui Portal Pengurusan Data.
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-50 flex items-center justify-center backdrop-blur-sm no-print">
        <div class="bg-white rounded-lg p-6 w-80 shadow-2xl border border-gray-200 transform transition-all scale-100">
            <div class="text-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">Admin Login</h3>
                <p class="text-xs text-gray-500">Sila masukkan katalaluan untuk akses data.</p>
            </div>
            <input type="password" id="adminPassInput" class="w-full border border-gray-300 p-2 rounded mb-4" placeholder="Katalaluan">
            <div class="flex justify-between space-x-2">
                <button onclick="toggleAdminLogin()" class="flex-1 px-3 py-2 text-gray-600 text-sm hover:bg-gray-100 rounded">Batal</button>
                <button onclick="checkLogin()" class="flex-1 px-4 py-2 bg-blue-900 text-white rounded hover:bg-blue-800 font-semibold shadow">Masuk</button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center no-print">
        <div class="relative p-5 border w-96 shadow-lg rounded-md bg-white text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Berjaya Dihantar!</h3>
            <button id="okBtn" class="mt-4 px-4 py-2 bg-blue-900 text-white rounded-md w-full">Tutup</button>
        </div>
    </div>

    <script>
        // URL UNTUK WRITE/UPDATE/DELETE (Google Apps Script - Updated)
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzgDduz8qkXK7oj3jkQRngU1nawm0e8K5qwM7HlCRl7e6iAKzS0kcwcy6ybEwFrOQlq/exec'; 
        
        // URL UNTUK READ (CSV - Laju & Tiada CORS)
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5EqsXq0jKKdeB4kBIcDmov_oAcRp6WwfR-mUjMnkIUQPbZHHyAYbQesaKzGXUG3AZoiIi6nL2k1IM/pub?output=csv';

        const ADMIN_PASSWORD = "admin123"; 

        // --- PUBLIC LOGIC ---
        
        // Fungsi baru untuk kawal dropdown "Lain-lain"
        function toggleManualInput(selectElement) {
            const container = document.getElementById('manualInputContainer');
            const input = document.getElementById('namaMasjidManual');
            
            if (selectElement.value === 'Lain-lain') {
                container.classList.remove('hidden');
                input.required = true;
                // Auto focus input bila muncul
                setTimeout(() => input.focus(), 100);
            } else {
                container.classList.add('hidden');
                input.required = false;
                input.value = ''; // Kosongkan jika tutup
            }
        }

        function updateFileName(input, spanId) {
            const fileNameSpan = document.getElementById(spanId);
            if (input.files && input.files.length > 0) {
                fileNameSpan.innerHTML = `<i class="fas fa-file-alt mr-2 text-green-600"></i> ${input.files[0].name}`;
                fileNameSpan.classList.add("text-gray-800"); fileNameSpan.classList.remove("text-gray-500");
            } else {
                fileNameSpan.innerHTML = `<i class="fas fa-cloud-upload-alt mr-2 text-blue-600"></i> Klik untuk muat naik`;
                fileNameSpan.classList.remove("text-gray-800"); fileNameSpan.classList.add("text-gray-500");
            }
        }

        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve({ data: reader.result.split(',')[1], name: file.name, mimeType: file.type });
                reader.onerror = error => reject(error);
            });
        };

        const form = document.getElementById('masjidForm');
        const modal = document.getElementById('successModal');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const btnHantar = document.getElementById('btnHantar');
        const btnText = document.getElementById('btnText');

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // --- VALIDASI MANUAL UNTUK FILE HIDDEN (Wajib Surau) ---
            const fileInputSurau = document.getElementById('fileAkaunSurau');
            const fileInputMasjid = document.getElementById('fileAkaun');

            if (fileInputSurau.files.length === 0) {
                alert("Sila muat naik Salinan Akaun Surau sebelum menghantar.");
                return; // Stop submission
            }
            if (fileInputMasjid.files.length === 0) {
                alert("Sila muat naik Salinan Akaun Masjid sebelum menghantar.");
                return; // Stop submission
            }

            btnHantar.disabled = true; btnHantar.classList.add('opacity-75', 'cursor-not-allowed');
            btnText.innerText = "SEDANG MENGHANTAR..."; loadingSpinner.style.display = "block";
            try {
                const formData = new FormData(form);
                const dataObject = Object.fromEntries(formData.entries());

                // LOGIK BARU: Handle "Lain-lain"
                if (dataObject.namaMasjid === 'Lain-lain') {
                    // Gantikan nilai 'Lain-lain' dengan apa yang user taip
                    dataObject.namaMasjid = dataObject.namaMasjidManual;
                }
                // Padam field manual dari dihantar ke DB supaya tak serabut (optional)
                delete dataObject.namaMasjidManual;
                
                if (fileInputMasjid.files.length > 0) dataObject.fileAkaun = await fileToBase64(fileInputMasjid.files[0]);
                if (fileInputSurau.files.length > 0) dataObject.fileAkaunSurau = await fileToBase64(fileInputSurau.files[0]);
                
                // Tambah action 'create' secara default jika takde
                dataObject.action = 'create';

                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(dataObject) });
                loadingSpinner.style.display = "none"; btnText.innerText = "HANTAR DATA";
                btnHantar.disabled = false; btnHantar.classList.remove('opacity-75', 'cursor-not-allowed');
                modal.classList.remove('hidden');
                form.reset();
                updateFileName(document.getElementById('fileAkaun'), 'fileName'); 
                updateFileName(document.getElementById('fileAkaunSurau'), 'fileNameSurau'); 
                
                // Reset dropdown manual input view
                document.getElementById('manualInputContainer').classList.add('hidden');
                
            } catch (error) {
                console.error(error); alert("Ralat teknikal semasa menghantar data.");
                loadingSpinner.style.display = "none"; btnText.innerText = "CUBA LAGI";
                btnHantar.disabled = false; btnHantar.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        });

        document.getElementById('okBtn').addEventListener('click', () => modal.classList.add('hidden'));

        // --- ADMIN LOGIC ---
        function toggleAdminLogin() {
            const modal = document.getElementById('adminLoginModal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) document.getElementById('adminPassInput').focus();
        }

        function checkLogin() {
            if (document.getElementById('adminPassInput').value === ADMIN_PASSWORD) {
                document.getElementById('adminLoginModal').classList.add('hidden');
                document.getElementById('publicSection').classList.add('hidden');
                document.getElementById('adminSection').classList.remove('hidden');
                fetchAdminData();
            } else { alert("Katalaluan salah!"); }
        }

        function logoutAdmin() {
            document.getElementById('adminSection').classList.add('hidden');
            document.getElementById('publicSection').classList.remove('hidden');
        }

        function getDriveThumbnail(url) {
            if (!url || url === 'Tiada Fail' || url.trim() === '') return null;
            const idMatch = url.match(/[-\w]{25,}/);
            if (idMatch) return `https://drive.google.com/thumbnail?id=${idMatch[0]}&sz=w1000`;
            return null;
        }

        function csvToArray(text) {
            let p = '', row = [''], ret = [row], i = 0, r = 0, s = !0, l;
            for (l of text) {
                if ('"' === l) {
                    if (s && l === p) row[i] += l; s = !s;
                } else if (',' === l && s) l = row[++i] = '';
                else if ('\n' === l && s) { if ('\r' === p) row[i] = row[i].slice(0, -1); row = ret[++r] = [l = '']; i = 0; } else row[i] += l; p = l;
            }
            return ret;
        }

        let adminDataCache = []; 

        async function fetchAdminData() {
            const status = document.getElementById('statusAdmin');
            const tbody = document.getElementById('adminTableBody');
            status.innerText = "Sedang memuat turun data...";
            tbody.innerHTML = `<tr><td colspan="6" class="text-center py-8"><i class="fas fa-circle-notch fa-spin mr-2"></i> Loading CSV...</td></tr>`;

            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                const csvText = await response.text();
                const rows = csvToArray(csvText);
                
                status.innerText = `Dikemaskini: ${new Date().toLocaleTimeString()}`;
                status.className = "text-xs text-green-600 italic";
                tbody.innerHTML = "";

                if (rows.length > 1) {
                    adminDataCache = rows.slice(1);
                    adminDataCache.forEach((row, index) => {
                        if (row.length < 2) return;
                        let dateStr = row[0];
                        try { dateStr = new Date(row[0]).toLocaleDateString('ms-MY'); } catch(e){}

                        const tr = document.createElement('tr');
                        tr.className = "border-b hover:bg-blue-50 transition group";
                        tr.innerHTML = `
                            <td class="py-3 px-4 whitespace-nowrap text-xs text-gray-500">${dateStr}</td>
                            <td class="py-3 px-4 font-bold text-blue-900">${row[1]}</td>
                            <td class="py-3 px-4">
                                <div class="font-semibold text-gray-800">${row[2]}</div>
                                <div class="text-xs text-gray-500 mt-1"><i class="fas fa-phone mr-1"></i> ${row[3]}</div>
                            </td>
                            <td class="py-3 px-4 font-mono text-gray-700 bg-gray-50 rounded text-center">${row[4]}</td>
                            <td class="py-3 px-4">
                                ${row[6] ? `<div class="font-semibold text-gray-700"><i class="fas fa-moon text-yellow-600 mr-1"></i> ${row[6]}</div>` : '<span class="text-gray-400">-</span>'}
                            </td>
                            <td class="py-3 px-4 text-center">
                                <div class="flex justify-center items-center space-x-2">
                                    <button onclick="openEditModal(${index})" class="bg-yellow-500 text-white p-2 rounded hover:bg-yellow-600 shadow" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteData(${index})" class="bg-red-500 text-white p-2 rounded hover:bg-red-600 shadow" title="Padam">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                    <button onclick="openPrintView(${index})" class="bg-blue-600 text-white p-2 rounded hover:bg-blue-700 shadow" title="PDF">
                                        <i class="fas fa-file-pdf"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = `<tr><td colspan="6" class="text-center py-8">Tiada data dijumpai.</td></tr>`;
                }
            } catch (e) {
                console.error("Fetch Error:", e);
                status.innerText = "Gagal menyambung.";
                status.className = "text-xs text-red-600 italic";
                alert("Ralat semasa mengambil data CSV: " + e.message);
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-red-500">Gagal memuat turun data.</td></tr>`;
            }
        }

        // --- NEW: EDIT & DELETE FUNCTIONS ---
        
        // DELETE
        async function deleteData(index) {
            if(!confirm("ADAKAH ANDA PASTI?\n\nData ini akan dipadam secara kekal dari Google Sheet. Tindakan ini tidak boleh dikembalikan.")) return;
            
            const btn = event.currentTarget;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                // Row Index di Google Sheet bermula dari 1. Header ialah row 1.
                // Data kita bermula dari row 2 (index 0 dalam array kita + 2)
                const sheetRow = index + 2; 

                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'delete',
                        row: sheetRow
                    })
                });

                // Tunggu sekejap sebelum refresh sebab Google Sheet ambil masa update CSV published link
                alert("Data telah dipadam. Sila tunggu sebentar untuk jadual dikemaskini.");
                setTimeout(fetchAdminData, 3000); 

            } catch(e) {
                alert("Gagal memadam data: " + e);
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        // EDIT: OPEN MODAL
        function openEditModal(index) {
            const row = adminDataCache[index];
            if(!row) return;

            document.getElementById('editRowIndex').value = index + 2; // Sheet Row Index
            document.getElementById('editNamaMasjid').value = row[1];
            document.getElementById('editNamaPengerusi').value = row[2];
            document.getElementById('editNoTelefon').value = row[3];
            document.getElementById('editNoAkaun').value = row[4];
            document.getElementById('editNamaSurau').value = row[6] || '';
            document.getElementById('editNoAkaunSurau').value = row[7] || '';

            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
        }

        // EDIT: SAVE SUBMIT
        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const btn = this.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Menyimpan...';
            btn.disabled = true;

            const payload = {
                action: 'edit',
                row: document.getElementById('editRowIndex').value,
                namaMasjid: document.getElementById('editNamaMasjid').value,
                namaPengerusi: document.getElementById('editNamaPengerusi').value,
                noTelefon: document.getElementById('editNoTelefon').value,
                noAkaun: document.getElementById('editNoAkaun').value,
                namaSurau: document.getElementById('editNamaSurau').value,
                noAkaunSurau: document.getElementById('editNoAkaunSurau').value
            };

            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                
                alert("Data berjaya dikemaskini! Sila tunggu sebentar untuk jadual dikemaskini.");
                closeEditModal();
                setTimeout(fetchAdminData, 3000); // Tunggu CSV update
                
            } catch(e) {
                alert("Ralat semasa menyimpan: " + e);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // --- SUMMARY REPORT LOGIC (BARU) ---
        function openSummaryReport() {
            if(adminDataCache.length === 0) {
                alert("Tiada data untuk dijana.");
                return;
            }

            const modal = document.getElementById('summaryModal');
            const tbody = document.getElementById('summaryTableBody');
            const dateSpan = document.getElementById('summaryDate');
            const countSpan = document.getElementById('totalDataCount');

            // Set Tarikh
            dateSpan.innerText = new Date().toLocaleDateString('ms-MY', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            countSpan.innerText = adminDataCache.length;

            // Bina Baris
            let html = '';
            adminDataCache.forEach((row, index) => {
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-300 px-2 py-2 text-center">${index + 1}</td>
                        <td class="border border-gray-300 px-2 py-2 font-semibold">${row[1]}</td>
                        <td class="border border-gray-300 px-2 py-2">${row[2]}</td>
                        <td class="border border-gray-300 px-2 py-2 text-center">${row[3]}</td>
                        <td class="border border-gray-300 px-2 py-2 text-center font-mono">${row[4]}</td>
                        <td class="border border-gray-300 px-2 py-2">${row[6] || '-'}</td>
                        <td class="border border-gray-300 px-2 py-2 text-center font-mono">${row[7] || '-'}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
            
            // Tukar Paparan
            document.getElementById('adminSection').classList.add('hidden');
            modal.classList.remove('hidden');
            window.scrollTo(0,0);
        }

        function closeSummaryReport() {
            document.getElementById('summaryModal').classList.add('hidden');
            document.getElementById('adminSection').classList.remove('hidden');
        }

        // --- PRINT / PDF VIEW LOGIC (INDIVIDU) ---
        function openPrintView(index) {
            const row = adminDataCache[index];
            if (!row) return;
            const printModal = document.getElementById('printModal');
            const content = document.getElementById('printContent');
            let dateStr = row[0];
            try { dateStr = new Date(row[0]).toLocaleDateString('ms-MY', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); } catch(e){}
            const imgMasjid = getDriveThumbnail(row[5]);
            const imgSurau = getDriveThumbnail(row[8]);

            let html = `
                <div class="mb-6">
                    <p class="text-right text-sm text-gray-500 mb-4">Tarikh Data: <strong>${dateStr}</strong></p>
                    <div class="bg-blue-50 p-6 rounded-lg border border-blue-100 mb-6">
                        <h3 class="text-lg font-bold text-blue-900 border-b border-blue-200 pb-2 mb-4">Butiran Masjid</h3>
                        <table class="w-full text-sm">
                            <tr class="border-b border-blue-100"><td class="py-2 w-1/3 text-gray-600">Nama Masjid</td><td class="py-2 font-bold text-gray-900">${row[1]}</td></tr>
                            <tr class="border-b border-blue-100"><td class="py-2 text-gray-600">Pengerusi</td><td class="py-2 font-semibold">${row[2]}</td></tr>
                            <tr class="border-b border-blue-100"><td class="py-2 text-gray-600">No. Telefon</td><td class="py-2">${row[3]}</td></tr>
                            <tr><td class="py-2 text-gray-600">No. Akaun Bank</td><td class="py-2 font-mono text-lg font-bold">${row[4]}</td></tr>
                        </table>
                    </div>
                    ${row[6] ? `<div class="bg-yellow-50 p-6 rounded-lg border border-yellow-100 mb-6"><h3 class="text-lg font-bold text-yellow-800 border-b border-yellow-200 pb-2 mb-4">Butiran Pencalonan Surau</h3><table class="w-full text-sm"><tr class="border-b border-yellow-100"><td class="py-2 w-1/3 text-gray-600">Nama Surau</td><td class="py-2 font-bold text-gray-900">${row[6]}</td></tr><tr><td class="py-2 text-gray-600">No. Akaun Surau</td><td class="py-2 font-mono text-lg font-bold">${row[7] || '-'}</td></tr></table></div>` : ''}
                    <div class="mt-8">
                        <h3 class="text-md font-bold text-gray-800 mb-4 bg-gray-200 p-2 rounded">Lampiran Penyata Akaun</h3>
                        <div class="mb-8"><p class="text-sm font-semibold mb-2">1. Penyata Akaun Masjid:</p>${imgMasjid ? `<div class="border p-2 rounded bg-gray-50 flex justify-center"><img src="${imgMasjid}" class="max-h-[300px] object-contain shadow-sm" alt="Penyata Masjid" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'"> <p class="hidden text-red-500 text-sm mt-2">Gagal memuatkan gambar preview.</p></div>` : '<div class="p-4 bg-gray-100 text-center text-gray-500 italic rounded">Tiada fail dimuat naik.</div>'}</div>
                        ${row[6] ? `<div><p class="text-sm font-semibold mb-2">2. Penyata Akaun Surau:</p>${imgSurau ? `<div class="border p-2 rounded bg-gray-50 flex justify-center"><img src="${imgSurau}" class="max-h-[300px] object-contain shadow-sm" alt="Penyata Surau" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'"> <p class="hidden text-red-500 text-sm mt-2">Gagal memuatkan gambar preview.</p></div>` : '<div class="p-4 bg-gray-100 text-center text-gray-500 italic rounded">Tiada fail surau dimuat naik.</div>'}</div>` : ''}
                    </div>
                </div>
            `;
            content.innerHTML = html;
            printModal.classList.remove('hidden');
            document.getElementById('adminSection').classList.add('hidden');
            window.scrollTo(0,0);
        }
        function closePrintView() {
            document.getElementById('printModal').classList.add('hidden');
            document.getElementById('adminSection').classList.remove('hidden');
        }
    </script>
</body>
</html>
